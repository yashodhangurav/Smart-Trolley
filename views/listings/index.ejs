<% layout("/layouts/boilerplate.ejs") %>

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

<body>
    <div class="tech-background"></div>

    <div class="container-fluid px-4 py-5 position-relative z-2">
        
        <div class="row mb-5 text-center" data-aos="fade-down">
            <div class="col-12">
                <span class="badge bg-primary-subtle text-primary rounded-pill mb-2 px-3 py-2">Smart Inventory</span>
                <h1 class="fw-bold display-5 mb-2 text-dark">Explore Products</h1>
                <p class="text-muted lead mx-auto" style="max-width: 600px;">
                    Browse our smart catalog. All items sync directly with your physical trolley.
                </p>
            </div>
        </div>

        <div class="glass-toolbar p-3 mb-5 rounded-4" data-aos="fade-up">
            <div class="row g-3 align-items-center">
                <div class="col-lg-6">
                    <div class="input-group search-group">
                        <span class="input-group-text bg-transparent border-0 ps-3">
                            <i class="fas fa-search text-primary"></i>
                        </span>
                        <input type="text" class="form-control bg-transparent border-0 py-2" id="searchInput" placeholder="Search by name, category...">
                        <button class="btn btn-primary rounded-pill px-4 m-1" type="button" id="searchBtn">Find</button>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="d-flex gap-2 overflow-auto pb-1 category-scroll">
                        <button class="filter-btn active" data-category="all">All</button>
                        <button class="filter-btn" data-category="groceries">Groceries</button>
                        <button class="filter-btn" data-category="beauty">Beauty</button>
                        <button class="filter-btn" data-category="electronics">Electronics</button> </div>
                </div>

                <div class="col-lg-2">
                    <select class="form-select border-0 bg-light-subtle rounded-pill" id="sortSelect" style="cursor: pointer;">
                        <option value="default">Sort: Default</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="name">Name: A to Z</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="row d-none" id="noResults">
            <div class="col-12 text-center py-5">
                <div class="empty-state-icon mb-3 mx-auto">
                    <i class="fas fa-search"></i>
                </div>
                <h4 class="fw-bold text-dark">No products found</h4>
                <p class="text-muted">Try adjusting your filters or search query.</p>
            </div>
        </div>

        <div class="row g-4">
            <% for(listing of allListings) { %>
            <div class="col-md-6 col-lg-4 col-xl-3" data-aos="fade-up" data-aos-delay="100">
                <div class="card product-card glass-card h-100 border-0">
                    
                    <div class="img-wrapper position-relative overflow-hidden rounded-top-4">
                        <img src="<%=listing.imageUrl.url%>" class="product-image" alt="<%= listing.title %>">
                        
                        <div class="position-absolute top-0 start-0 p-3 w-100 d-flex justify-content-between">
                            <span class="category-pill"><%= listing.category %></span>
                            <% if(listing.stock < 10) { %>
                                <span class="badge bg-danger rounded-pill shadow-sm">Low Stock</span>
                            <% } %>
                        </div>
                    </div>

                    <div class="card-body p-4 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title fw-bold mb-0 text-dark text-truncate" title="<%=listing.title%>">
                                <%=listing.title%>
                            </h5>
                        </div>
                        
                        <p class="small text-muted mb-2"><i class="fas fa-map-marker-alt me-1 text-primary"></i> <%=listing.location%></p>
                        
                        <div class="mb-3">
                            <% 
                                const rating = listing.rating || 4.5;
                                const fullStars = Math.floor(rating);
                                const emptyStars = 5 - fullStars;
                            %>
                            <div class="rating-stars text-warning small">
                                <%= '★'.repeat(fullStars) %><%= '☆'.repeat(emptyStars) %>
                                <span class="text-muted ms-1 small">(<%= rating %>)</span>
                            </div>
                        </div>

                        <p class="card-text text-muted small mb-4 flex-grow-1" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            <%= listing.description %>
                        </p>

                        <div class="d-flex align-items-center justify-content-between pt-3 border-top border-light">
                            <div>
                                <small class="text-muted d-block" style="font-size: 0.75rem;">Price per day</small>
                                <div class="price-tag">₹<%=listing.pricePerDay.toLocaleString("en-IN")%></div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <a href="/home/listings/<%=listing._id%>" class="btn btn-light btn-icon rounded-circle" data-bs-toggle="tooltip" title="View Details">
                                    <i class="fas fa-eye text-primary"></i>
                                </a>
                                <button 
                                    class="btn btn-primary btn-icon rounded-circle btn-glow"
                                    data-bs-toggle="tooltip" 
                                    title="Add to Cart"
                                    onclick="addToCart(
                                        '<%= listing._id %>', 
                                        '<%= listing.title %>', 
                                        '<%= listing.pricePerDay %>', 
                                        '<%= listing.imageUrl.url %>'
                                    )">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <span class="category-badge d-none"><%= listing.category %></span>
                    <span class="stock-badge d-none"><%=listing.stock%></span>
                </div>
            </div>
            <% } %>
        </div>

        <div class="row mt-5" data-aos="fade-up">
            <div class="col-12">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center gap-2">
                        <li class="page-item disabled">
                            <a class="page-link rounded-circle d-flex align-items-center justify-content-center" href="#" tabindex="-1"><i class="fas fa-chevron-left"></i></a>
                        </li>
                        <li class="page-item active"><a class="page-link rounded-circle d-flex align-items-center justify-content-center" href="#">1</a></li>
                        <li class="page-item"><a class="page-link rounded-circle d-flex align-items-center justify-content-center" href="#">2</a></li>
                        <li class="page-item"><a class="page-link rounded-circle d-flex align-items-center justify-content-center" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link rounded-circle d-flex align-items-center justify-content-center" href="#"><i class="fas fa-chevron-right"></i></a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>

    </div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script> AOS.init({ once: true }); </script>

    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --font-main: 'Outfit', sans-serif;
        }

        body { font-family: var(--font-main); background-color: #f8f9fa; }

        /* Tech Background */
        .tech-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background-color: #f8faff;
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 40px 40px; opacity: 0.6; pointer-events: none;
        }

        /* Glass Toolbar */
        .glass-toolbar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid white;
            box-shadow: 0 10px 30px rgba(67, 97, 238, 0.05);
        }

        .search-group {
            background: #f1f5f9;
            border-radius: 50px;
            padding: 2px;
            border: 1px solid transparent;
            transition: all 0.3s;
        }
        .search-group:focus-within {
            background: white;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
        }

        /* Filter Chips */
        .filter-btn {
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .filter-btn:hover { background: #f8fafc; color: var(--primary-color); }
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        /* Glass Product Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(67, 97, 238, 0.1);
            background: rgba(255, 255, 255, 0.9);
        }

        .img-wrapper { height: 220px; width: 100%; background: #fff; }
        .product-image {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.5s ease;
        }
        .glass-card:hover .product-image { transform: scale(1.08); }

        .category-pill {
            background: rgba(255, 255, 255, 0.9);
            color: var(--dark-text);
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 600;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .price-tag {
            font-size: 1.25rem; font-weight: 700; color: #2b2d42;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
        }
        .btn-glow:hover {
            box-shadow: 0 0 15px rgba(67, 97, 238, 0.5);
            transform: scale(1.1);
        }
        .btn-icon { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; }

        /* Pagination */
        .page-link {
            width: 40px; height: 40px; border: none; color: #64748b; font-weight: 600;
        }
        .page-item.active .page-link {
            background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }
        .empty-state-icon {
            width: 80px; height: 80px; background: #f1f5f9; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #cbd5e1;
        }
    </style>

    <script>
        // ------------------- SEARCH FUNCTION -------------------
        document.getElementById("searchInput").addEventListener("input", function () {
            const query = this.value.toLowerCase().trim();
            filterProducts();
        });

        // Search button
        document.getElementById("searchBtn").addEventListener("click", filterProducts);

        // ------------------- SORT FUNCTION -------------------
        document.getElementById("sortSelect").addEventListener("change", filterProducts);

        // ------------------- CATEGORY FILTER FUNCTION -------------------
        const filterButtons = document.querySelectorAll(".filter-btn");
        filterButtons.forEach(btn => {
            btn.addEventListener("click", function () {
                filterButtons.forEach(b => b.classList.remove("active"));
                this.classList.add("active");
                filterProducts();
            });
        });

        // ------------------- MAIN FILTER FUNCTION -------------------
        function filterProducts() {
            const searchValue = document.getElementById("searchInput").value.toLowerCase();
            const sortValue = document.getElementById("sortSelect").value;
            const selectedCategory = document.querySelector(".filter-btn.active").dataset.category;

            const cards = document.querySelectorAll(".product-card");
            // NOTE: We target the column wrapper for display logic
            const wrappers = document.querySelectorAll(".col-md-6.col-lg-4.col-xl-3");

            let visibleCount = 0;

            wrappers.forEach((wrapper, index) => {
                const card = cards[index];
                // Selectors updated to match new HTML structure
                const title = card.querySelector(".card-title").innerText.toLowerCase();
                // We use the hidden span or the pill for category logic
                const category = card.querySelector(".category-badge.d-none") ? card.querySelector(".category-badge.d-none").innerText.toLowerCase() : "";

                let show = true;

                // Filter by search
                if (!title.includes(searchValue) && !category.includes(searchValue)) {
                    show = false;
                }

                // Filter by category
                if (selectedCategory !== "all" && category !== selectedCategory) {
                    show = false;
                }

                // Show / hide
                wrapper.style.display = show ? "block" : "none";
                if (show) visibleCount++;
            });

            // No results section
            document.getElementById("noResults").classList.toggle("d-none", visibleCount !== 0);

            // SORTING
            sortProducts(sortValue);
        }

        // ------------------- SORT CARDS -------------------
        function sortProducts(type) {
            const container = document.querySelector(".row.g-4");
            const wrappers = Array.from(container.children); // Get the columns

            if (type === "price-low") {
                wrappers.sort((a, b) => {
                    const priceA = Number(a.querySelector(".price-tag").innerText.replace("₹", "").replace(",", ""));
                    const priceB = Number(b.querySelector(".price-tag").innerText.replace("₹", "").replace(",", ""));
                    return priceA - priceB;
                });
            }
            else if (type === "price-high") {
                wrappers.sort((a, b) => {
                    const priceA = Number(a.querySelector(".price-tag").innerText.replace("₹", "").replace(",", ""));
                    const priceB = Number(b.querySelector(".price-tag").innerText.replace("₹", "").replace(",", ""));
                    return priceB - priceA;
                });
            }
            else if (type === "name") {
                wrappers.sort((a, b) => {
                    const titleA = a.querySelector(".card-title").innerText;
                    const titleB = b.querySelector(".card-title").innerText;
                    return titleA.localeCompare(titleB);
                });
            }

            container.innerHTML = "";
            wrappers.forEach(wrapper => container.appendChild(wrapper));
        }

        // ------------------- ADD TO CART -------------------
        function addToCart(id, title, price, img) {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            let existingItem = cart.find(item => item.id === id);

            if (existingItem) {
                existingItem.qty += 1;
            } else {
                cart.push({ id: id, title: title, price: price, img: img, qty: 1 });
            }

            localStorage.setItem("cart", JSON.stringify(cart));
            
            // Optional: Fancy notification could go here instead of alert
            alert(title + " added to trolley!");
        }
    </script>
</body>